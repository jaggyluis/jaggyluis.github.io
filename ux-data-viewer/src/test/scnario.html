

	var percentageValue = 50;

    mapboxgl.accessToken = 'pk.eyJ1IjoibDAwYnkiLCJhIjoiMDNmOTJjMDRlNThlY2UzYTUyMDY1YzM5YjAyZWJlM2IifQ.ZPZ1QAs1tk5OQgt4AwPrVw';

    const {MapboxLayer, GeoJsonLayer} = deck;

    const map = new mapboxgl.Map({
      container: document.body,
      style:  'mapbox://styles/l00by/cjnehq8jx37ag2rsf2v4zt9rc', //'mapbox://styles/mapbox/dark-v9',
	  /*style: {
		"version": 8,
		"name": "blank",
		"sources": {
		  "openmaptiles": {
			"type": "vector",
			"url": ""
		  }
		},
		"layers": [{
		  "id": "background",
		  "type": "background",
		  "paint": {
			"background-color": "#d1c6a8"
		  }
		}]
	  },*/
	  //downtown
	  //center: [-118.245896, 34.03903672],
      //zoom: 13.4,
      //pitch: 50,
	  //maxZoom: 17
	  //east LA
	  center: [-118.16912901,34.032625057],
      //bearing: 25.3,
	  pitch: 50,
      zoom: 13.3,
	  maxZoom: 17
    });

    //const DATA_URL = 'weighted_lots/Downtown_rand.geojson';
	//const DATA_URL_buildings = 'weighted_lots/Downtown__buildings_simp.geojson';
	//const DATA_URL_parcels = 'weighted_lots/Downtown__parcels.geojson';

	const DATA_URL = 'weighted_lots/East Los Angeles_rand.geojson';
	const DATA_URL_buildings = 'weighted_lots/East Los Angeles__buildings_simp.geojson';
	const DATA_URL_parcels = 'weighted_lots/East Los Angeles__parcels.geojson';

    const OPTIONS = ['percentage'];

	const LIGHT_SETTINGS = {
      lightsPosition: [-115.273, 31.955, 500000, -121.037, 35.655, 800000],
      ambientRatio: 0.45,
      diffuseRatio: 0.6,
      specularRatio: 0.2,
      lightsStrength: [0.8, 0.8, 0.8, 0.8],
      numberOfLights: 2
    };

    let geojsonLayer;

	rng_seed(53);

    map.on('load', () => {

	  //const firstLabelLayerId = map.getStyle().layers.find(layer => layer.type === 'symbol').id;

	   //hill shading
	   /*
	   map.addSource('dem', {
        "type": "raster-dem",
        "url": "mapbox://mapbox.terrain-rgb"
		});
		map.addLayer({
			"id": "hillshading",
			"source": "dem",
			"type": "hillshade"
		// insert below waterway-river-canal-shadow;
		// where hillshading sits in the Mapbox Outdoors style
		}, 'building');
		*/
		/*
		map.addLayer(
			new MapboxLayer({
				  type: GeoJsonLayer,
				  id: 'parcels-downtown',
				  data: DATA_URL_parcels,
				  opacity: 0.5, //f => getBuildingOpacity(),
				  stroked: true,
				  filled: true,
				  extruded: false,
				  wireframe: false,
				  fp64: true,
				  lightSettings: LIGHT_SETTINGS,
				  getFillColor: f => [156,197,218],
				  getLineColor: f => [156,197,218],
				 // getLineColor: f => [0,0,0],
				  lineWidthMaxPixels: 0.5,
				  pickable: false//,
				  //onHover: updateTooltip
				})
		);
		*/

		map.addLayer(
			new MapboxLayer({
				  type: GeoJsonLayer,
				  id: '3D-downtown',
				  data: DATA_URL_buildings,
				  opacity: 0.8, //f => getBuildingOpacity(),
				  stroked: true,
				  filled: true,
				  extruded: true,
				  wireframe: false,
				  fp64: true,
				  lightSettings: LIGHT_SETTINGS,
				  getElevation: f => f.properties.height_m,
				  getFillColor: f => [214,216,213],
				  getLineColor: f => [214,216,213],
				  lineWidthMaxPixels: 0.5,
				  pickable: true//,
				  //onHover: updateTooltip
				  /*updateTriggers: {
					  getElevation: {percentageValue}
				  },
				  transitions: {
					  getElevation: 1000
				  }*/
				}, 'parcels-downtown')
		);

		geojsonLayer = updateLayer(percentageValue);

		//map.addLayer(geojsonLayer, 'road-label');
		map.addLayer(geojsonLayer, '3D-downtown');

    });


	function updateLayer(pv) {
		return new MapboxLayer({
			  type: GeoJsonLayer,
			  id: 'parking_lots',
			  data: DATA_URL,
			  opacity: 0.6, //f => getBuildingOpacity(),
			  stroked: false,
			  filled: true,
			  extruded: true,
			  wireframe: false,
			  fp64: true,
			  lightSettings: LIGHT_SETTINGS,
			  getElevation: f => getBuildingElevation(f, pv), //f.properties.b__mean_height_m, // Math.sqrt(f.properties.b__mean_height_m) * 100,
			  getFillColor: f => [255,54,39], //getBuildingColor(f, pv), //, //[255,54,39, 180], //colorScale(f.properties.catchments_metro/1000.0),
			 // getLineColor: f => [0,0,0],
			  lineWidthMaxPixels: 0.5,
			  pickable: true//,
			  //onHover: updateTooltip
			  /*updateTriggers: {
				  getElevation: {percentageValue}
			  },
			  transitions: {
				  getElevation: 1000
			  }*/
			});

	}

	function getBuildingElevation_test(f) {
		tempRand = rng_random();
		f.properties.area = tempRand;
		return tempRand<=0.01*percentageValue ? f.properties.b__median_height_m__800 : 0;
	}

	function getBuildingElevation(f, pv) {
		return f.properties.random*100<=pv ? f.properties.b__median_height_m__800 : 0;
	}

	function getBuildingColor(f, pv) {
		//return f.properties.random*100<=pv ? f.properties.b__median_height_m__800 : 0;
		return f.properties.random*100<=pv ? [255,54,39] : [50,255,60];
	}

	function isVisible(seedNo) {
		rng_seed(parseInt(seedNo));
		console.log(rng_random()>=0.01*percentageValue);
		return (rng_random()>=0.01*percentageValue);
	}

	function getBuildingColor() {
		//console.log(rng_random());
		ran = (rng_random()<0.01*percentageValue ? 0.6 : 0);
		//console.log(ran);
		return [255,54,39, Math.round(255*ran)];
	}

	function getBuildingOpacity() {
		return 0; //return (rng_random()<0.01*percentageValue ? 0.6 : 0);
	}

    OPTIONS.forEach(key => {
      document.getElementById(key).oninput = (evt) => {
        const value = Number(evt.target.value);
        document.getElementById(key + '-value').innerHTML = value;
		percentageValue = value;
		console.log("Set percentage:")
		console.log(value);
        if (geojsonLayer) {
			map.removeLayer('parking_lots');
			map.addLayer(updateLayer(percentageValue));
			//geojsonLayer = updateLayer(percentageValue);
			/*(map.getLayer('parking_lots')).setProps({
				getColor: [0,0,255]
			});*/
			//geojsonLayer.setProps({["percentageValue"]: value})
			//geojsonLayer.setElevation(percentageValue*f.properties.b__mean_height_m);
          //geojsonLayer.setProps({[key]: value});
		  //geojsonLayer.setProps({['opacity']: percentageValue*0.01});
        }
      };
    });


	//random number generator with seed
	//https://stackoverflow.com/questions/521295/seeding-the-random-number-generator-in-javascript
	var rng_m_w = 123456789;
	var rng_m_z = 987654321;
	var rng_mask = 0xffffffff;

	// Takes any integer
	function rng_seed(i) {
		rng_m_w = i;
		rng_m_z = 987654321;
	}

	// Returns number between 0 (inclusive) and 1.0 (exclusive),
	// just like Math.random().
	function rng_random()
	{
		rng_m_z = (36969 * (rng_m_z & 65535) + (rng_m_z >> 16)) & rng_mask;
		rng_m_w = (18000 * (rng_m_w & 65535) + (rng_m_w >> 16)) & rng_mask;
		var result = ((rng_m_z << 16) + rng_m_w) & rng_mask;
		result /= 4294967296;
		return result + 0.5;
	}
